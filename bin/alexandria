#!/usr/bin/env ruby

require 'clive'
require 'pp'
require 'data_mapper'
require 'highline/import'

LIB_ROOT = File.expand_path(ENV['ALEXANDRIA_LIBRARY'] || '~/alexandria')

FileUtils.mkdir_p LIB_ROOT
DataMapper.setup(:default, "sqlite://#{LIB_ROOT}/library.db")

require_relative '../lib/alexandria'

class Alexandria::CLI < Clive

  desc 'Adds a book to library, converting it to all formats'
  command :add, arg: '<path>...' do
    bool :quiet, default: true
    bool :force, default: false

    action do
      options = {
        quiet: get(:quiet),
        force: get(:force)
      }

      path.each {|book_path|
        ::Alexandria::Library.add book_path, options
      }
    end
  end

  desc 'Lists all books in the library'
  command :list do
    desc 'Show only for author'
    opt :author, args: '<name>'

    desc 'Show only with title'
    opt :title, args: '<name>'

    desc 'List by author'
    bool :by_author

    desc 'Show full output'
    bool :v, :verbose

    action do
      criteria = {
        title: get(:title),
        author: {
          name: get(:author)
        }
      }

      if get(:by_author)
        ::Alexandria::Library.authors(criteria[:author]).each do |author|
          puts author.name.bold

          author.books.each do |book|
            puts "  #{book.title}"
            puts "    #{book.path}\n".grey if get(:verbose)
          end
        end

      else
        ::Alexandria::Library.books(criteria).each do |book|
          puts "#{book.title.bold} by #{book.author.name}"
          puts "  #{book.path}\n".grey if get(:verbose)
        end
      end
    end
  end

  desc 'Syncs books from a connected device to the library'
  command :sync do
    bool :dry_run

    action do
      device = ::Alexandria::Device.find

      unless device
        puts "Nothing to sync.".red
        exit
      end

      device.each_book do |book|
        unless Book.any?(author: book.author, title: book.title)
          if get(:dry_run)
            puts "Missing: #{book.title} by #{book.author}"
          else
            ::Alexandria::Library.add(book)
          end
        end
      end
    end
  end
end

Alexandria::CLI.run
